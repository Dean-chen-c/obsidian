## LVM介绍

LVM是 Logical Volume Manager（逻辑卷管理）的简写，它是Linux环境下对磁盘分区进行管理的一种机制，它由Heinz Mauelshagen在Linux 2.4内核上实现，最新版本为：稳定版1.0.5，开发版 1.1.0-rc2，以及LVM2开发版。Linux用户安装Linux操作系统时遇到的一个常见的难以决定的问题就是如何正确地评估各分区大小，以分配合适的硬盘空间。普通的磁盘分区管理方式在逻辑分区划分好之后就无法改变其大小，当一个逻辑分区存放不下某个文件时，这个文件因为受上层文件系统的限制，也不能跨越多个分区来存放，所以也不能同时放到别的磁盘上。而遇到出现某个分区空间耗尽时，解决的方法通常是使用符号链接，或者使用调整分区大小的工具，但这只是暂时解决办法，没有从根本上解决问题。随着Linux的逻辑卷管理功能的出现，这些问题都迎刃而解，用户在无需停机的情况下可以方便地调整各个分区大小。

逻辑卷管理器(LogicalVolumeManager)本质上是一个虚拟设备驱动，是在内核中块设备和物理设备之间添加的一个新的抽象层次，如图所示。它可以将几块磁盘(物理卷，PhysicalVolume)组合起来形成一个存储池或者卷组(VolumeGroup)。LVM可以每次从卷组中划分出不同大小的逻辑卷(LogicalVolume)创建新的逻辑设备。底层的原始的磁盘不再由内核直接控制，而由LVM层来控制。对于上层应用来说卷组替代了磁盘块成为数据存储的基本单元。LVM管理着所有物理卷的物理盘区，维持着逻辑盘区和物理盘区之间的映射。LVM逻辑设备向上层应用提供了和物理磁盘相同的功能，如文件系统的创建和数据的访问等。但LVM逻辑设备不受物理约束的限制，逻辑卷不必是连续的空间，它可以跨越许多物理卷，并且可以在任何时候任意的调整大小。相比物理磁盘来说，更易于磁盘空间的管理。

![gh](https://cdn.jsdelivr.net/gh/Dean-chen-c/obsidian@main/main/images/16931870530002xltsn.png)


从用户态应用来看，LVM逻辑卷相当于一个普通的块设备，对其的读写操作和普通的块设备完全相同。而从物理设备层来看，LVM相对独立于底层的物理设备，并且屏蔽了不同物理设备之间的差异。因而在LVM层上实现数据的连续保护问题，可以不需要单独考虑每一种具体的物理设备，避免了在数据复制过程中因物理设备之间的差异而产生的问题。从LVM的内核实现原理上看，LVM是在内核通用块设备层到磁盘设备驱动层的请求提交流之间开辟的另外一条路径，即在通用块设备层到磁盘设备驱动层之间插入了LVM管理映射层用于截获一定的请求进行处理。

![gh](https://cdn.jsdelivr.net/gh/Dean-chen-c/obsidian@main/main/images/1693187120000fkwmyv.png)


## 基本术语

- 物理存储介质（PhysicalStorageMedia）  
    指系统的物理存储设备：磁盘，如：/dev/hda、/dev/sda等，是存储系统最底层的存储单元。
- 物理卷（Physical Volume，PV）  
    指磁盘分区或从逻辑上与磁盘分区具有同样功能的设备（如RAID），是LVM的基本存储逻辑块，但和基本的物理存储介质（如分区、磁盘等）比较，却包含有与LVM相关的管理参数。
- 卷组（Volume Group，VG）  
    类似于非LVM系统中的物理磁盘，其由一个或多个物理卷PV组成。可以在卷组上创建一个或多个LV（逻辑卷）。
- 逻辑卷（Logical Volume，LV）  
    类似于非LVM系统中的磁盘分区，逻辑卷建立在卷组VG之上。在逻辑卷LV之上可以建立文件系统（比如/home或者/usr等）。
- 物理块（Physical Extent，PE）  
    PE是物理卷PV的基本划分单元，具有唯一编号的PE是可以被LVM寻址的最小单元。PE的大小是可配置的，默认为4MB。所以物理卷（PV）由大小等同的基本单元PE组成。
- 逻辑块（Logical Extent，LE）  
    逻辑卷LV也被划分为可被寻址的基本单位，称为LE。在同一个卷组中，LE的大小和PE是相同的，并且一一对应。  
    图所示LVM抽象模型，展示了PV、VG、LV三者之间关系：

![gh](https://cdn.jsdelivr.net/gh/Dean-chen-c/obsidian@main/main/images/1693187143000vqu3ro.png)


## 传统分区格式介绍

1. MBR分区  
    MBR的意思是“主引导记录”，它是存在于驱动器开始部分的一个特殊的启动扇区。这个扇区包含了已安装的操作系统的启动加载器和驱动器的逻辑分区信息。MBR支持最大2TB磁盘，它无法处理大于2TB容量的磁盘。MBR格式的磁盘分区主要分为基本分区（primary partion）和扩展分区（extension partion）两种主分区和扩展分区下的逻辑分区。主分区总数不能大于4个，其中最多只能有一个扩展分区。且基本分区可以马上被挂载使用但不能再分区，扩展分区必须再进行二次分区后才能挂载。扩展分区下的二次分区被称之为逻辑分区，逻辑分区数量限制视磁盘类型而定。
    
    MBR的主分区号为1-4，逻辑分区号为从5开始累加的数字。比如设备主板上装了4块硬盘，分别为2块IDE接口硬盘，1块SCSI接口硬盘和一块SATA接口硬盘。其中2块IDE接口硬盘的分区策略为2个主分区和2个逻辑分区，SCSI分区策略为3个主分区和3个逻辑分区，SATA分区策略为4个主分区。硬盘文件和分区名称如下：
    
    硬盘 主分区1 主分区2 主分区3 主分区4 逻辑分区1 逻辑分区2 逻辑分区3 … 逻辑分区n  
    IDE1 /dev/hda /dev/hda1§ /dev/hda2§ /dev/hda3(e) / /dev/hda5(l) /dev/hda6(l) / … /  
    IDE2 /dev/hdb /dev/hdb1§ /dev/hdb2§ /dev/hdb3(e) / /dev/hdb5(l) /dev/hdb6(l) / … /  
    SCSI /dev/sda /dev/sda1§ /dev/sda2§ /dev/sda3§ /dev/sda4(e) /dev/sda5(l) /dev/sda6(l) /dev/sda7(l) … /  
    SATA /dev/sdb /dev/sdb1§ /dev/sdb2§ /dev/sdb3§ /dev/sdb4§ / / / … /  
    
    其中分区名称后面的（p）代表基本分区，（e）代表扩展分区，（l）代表逻辑分区。需要注意的是，如果分区策略中存在逻辑分区，则说明一定会有扩展分区，那么基本分区数则最多只能有3个，扩展分区数最多只能是1个，如果没有扩展分区则可以创建4个基本分区。想要创建逻辑分区，则必须先将唯一的扩展分区创建出来，并且如果删除了扩展分区，那么它下面的所有逻辑分区也会被自动删除。
    
    如果是SCSI接口硬盘则最多只能有15（其中扩展分区不能直接使用所以不计算）个分区，其中主分区最多4个，逻辑分区最多12个。IDE接口硬盘最多只能有63（其中扩展分区不能直接使用所以不计算）个分区，其中主分区最多4个，逻辑分区最多60个。
2. GPT分区  
    GPT意为GUID分区表，驱动器上的每个分区都有一个全局唯一的标识符（globally unique identifier，GUID）。支持的最大磁盘可达18EB，它没有主分区和逻辑分区之分，每个硬盘最多可以有128个分区，具有更强的健壮性与更大的兼容性，并且将逐步取代MBR分区方式。GPT分区的命名和MBR类似，只不过没有主分区、扩展分区和逻辑分区之分，分区号直接从1开始累加一直到128。

## 总结

lvm 是介于文件系统与硬件设备之间的一个抽象层。

lvm 对上作为一个硬件设备，可以装上文件系统。

lvm 对下作为一个文件系统管理硬件设备。

lvm 屏蔽了下层硬件细节，实现动态的增减硬盘空间。

![gh](https://cdn.jsdelivr.net/gh/Dean-chen-c/obsidian@main/main/images/1696816802000zy1f4a.png)

1. PV 建立在 硬盘或硬盘分区之上
2. VG 包含一组 PV 卷。
3. LV 从 VG 中创建
4. LV 与 PV 没有映射关系。
5. LV 与 PV 是通过 LE、PE 基本单元映射，通过 VG 解耦。
6. LV 作用与传统 硬盘分区是一样的，在 lV 上安装文件系统，挂载。